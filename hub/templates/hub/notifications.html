{% extends 'hub/base.html' %}

{% block title %}Notifications - EduCycle{% endblock %}

{% block content %}
<!-- Anime.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="notifications-title">
                    <i class="fas fa-bell text-primary"></i> Notifications
                </h1>
                <div>
                    <button class="btn btn-outline-primary mark-all-btn" onclick="markAllRead()">
                        <i class="fas fa-check-double"></i> Mark All as Read
                    </button>
                </div>
            </div>
            
            {% if notifications %}
                <div class="row">
                    <div class="col-12">
                        <div class="card notifications-card">
                            <div class="card-body">
                                {% for notification in notifications %}
                                    <div class="notification-item border-bottom py-3 {% if not notification.is_read %}unread-notification{% endif %}" 
                                         data-notification-id="{{ notification.id }}"
                                         data-notification-index="{{ forloop.counter0 }}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center mb-2">
                                                    <div class="notification-icon me-3">
                                                        {% if notification.notification_type == 'item_added' %}
                                                            <i class="fas fa-plus-circle text-success"></i>
                                                        {% elif notification.notification_type == 'item_sold' %}
                                                            <i class="fas fa-shopping-cart text-primary"></i>
                                                        {% elif notification.notification_type == 'item_purchased' %}
                                                            <i class="fas fa-shopping-bag text-info"></i>
                                                        {% elif notification.notification_type == 'review_received' %}
                                                            <i class="fas fa-star text-warning"></i>
                                                        {% elif notification.notification_type == 'message_received' %}
                                                            <i class="fas fa-envelope text-secondary"></i>
                                                        {% elif notification.notification_type == 'order_status' %}
                                                            <i class="fas fa-truck text-dark"></i>
                                                        {% else %}
                                                            <i class="fas fa-bell text-muted"></i>
                                                        {% endif %}
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1 notification-title {% if not notification.is_read %}fw-bold{% endif %}">
                                                            {{ notification.title }}
                                                        </h6>
                                                        <p class="text-muted mb-1 notification-message">{{ notification.message }}</p>
                                                        <small class="text-muted notification-time">
                                                            <i class="fas fa-clock"></i> {{ notification.created_at|timesince }} ago
                                                        </small>
                                                    </div>
                                                </div>
                                                
                                                {% if notification.related_item %}
                                                    <div class="mt-2 notification-actions">
                                                        <a href="{% url 'item_detail' notification.related_item.id %}" class="btn btn-sm btn-outline-primary action-btn">
                                                            <i class="fas fa-eye"></i> View Item
                                                        </a>
                                                    </div>
                                                {% endif %}
                                                
                                                {% if notification.related_order %}
                                                    <div class="mt-2 notification-actions">
                                                        <a href="{% url 'order_detail' notification.related_order.id %}" class="btn btn-sm btn-outline-info action-btn">
                                                            <i class="fas fa-receipt"></i> View Order
                                                        </a>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="ms-3">
                                                {% if not notification.is_read %}
                                                    <button class="btn btn-sm btn-outline-success mark-read-btn" onclick="markAsRead({{ notification.id }})">
                                                        <i class="fas fa-check"></i> Mark Read
                                                    </button>
                                                {% else %}
                                                    <span class="badge bg-success read-badge">Read</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="row">
                    <div class="col-12">
                        <div class="card empty-notifications-card">
                            <div class="card-body text-center py-5">
                                <div class="empty-icon">
                                    <i class="fas fa-bell-slash text-muted"></i>
                                </div>
                                <h4 class="mt-3 text-muted empty-title">No Notifications</h4>
                                <p class="text-muted empty-description">You don't have any notifications yet. When you add items, make purchases, or receive messages, you'll see them here.</p>
                                <a href="{% url 'item_list' %}" class="btn btn-primary browse-btn">
                                    <i class="fas fa-shopping-cart"></i> Browse Items
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Initialize animations on page load
document.addEventListener('DOMContentLoaded', function() {
    // Animate page title
    anime({
        targets: '.notifications-title',
        opacity: [0, 1],
        translateY: [-20, 0],
        duration: 800,
        easing: 'easeOutCubic'
    });

    // Animate mark all button
    anime({
        targets: '.mark-all-btn',
        opacity: [0, 1],
        translateX: [20, 0],
        duration: 800,
        delay: 200,
        easing: 'easeOutCubic'
    });

    // Animate notification items
    anime({
        targets: '.notification-item',
        opacity: [0, 1],
        translateX: [-30, 0],
        delay: anime.stagger(100),
        duration: 600,
        easing: 'easeOutCubic'
    });

    // Animate empty state if no notifications
    if (document.querySelector('.empty-notifications-card')) {
        anime({
            targets: '.empty-icon i',
            scale: [0, 1],
            rotate: [180, 0],
            duration: 1000,
            easing: 'easeOutElastic(1, 0.5)'
        });

        anime({
            targets: ['.empty-title', '.empty-description', '.browse-btn'],
            opacity: [0, 1],
            translateY: [20, 0],
            delay: anime.stagger(200),
            duration: 600,
            easing: 'easeOutCubic'
        });
    }
});

function markAsRead(notificationId) {
    const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
    const markReadBtn = notificationItem.querySelector('.mark-read-btn');
    
    // Animate button click
    anime({
        targets: markReadBtn,
        scale: [1, 0.95, 1],
        duration: 200,
        easing: 'easeInOutQuad'
    });

    fetch(`/notifications/${notificationId}/read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Animate notification item transition
            anime({
                targets: notificationItem,
                backgroundColor: ['#f8f9fa', '#ffffff'],
                duration: 500,
                easing: 'easeOutCubic'
            });

            // Replace button with badge
            const badge = document.createElement('span');
            badge.className = 'badge bg-success read-badge';
            badge.textContent = 'Read';
            
            // Animate badge entrance
            badge.style.opacity = '0';
            badge.style.transform = 'scale(0)';
            markReadBtn.parentNode.replaceChild(badge, markReadBtn);
            
            anime({
                targets: badge,
                opacity: [0, 1],
                scale: [0, 1],
                duration: 400,
                easing: 'easeOutBack(1.7)'
            });

            // Remove unread styling
            notificationItem.classList.remove('unread-notification');
            
            // Update notification count in navbar
            updateNotificationCount();
        }
    })
    .catch(error => {
        console.error('Error marking notification as read:', error);
        // Show error animation
        anime({
            targets: markReadBtn,
            translateX: [-5, 5, -5, 5, 0],
            duration: 400,
            easing: 'easeInOutQuad'
        });
    });
}

function markAllRead() {
    const markAllBtn = document.querySelector('.mark-all-btn');
    
    // Animate button click
    anime({
        targets: markAllBtn,
        scale: [1, 0.95, 1],
        duration: 200,
        easing: 'easeInOutQuad'
    });

    fetch('/notifications/mark-all-read/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Animate all unread notifications
            const unreadNotifications = document.querySelectorAll('.unread-notification');
            
            anime({
                targets: unreadNotifications,
                backgroundColor: ['#f8f9fa', '#ffffff'],
                delay: anime.stagger(50),
                duration: 500,
                easing: 'easeOutCubic',
                complete: function() {
                    // Replace all mark read buttons with badges
                    unreadNotifications.forEach(item => {
                        const markReadBtn = item.querySelector('.mark-read-btn');
                        if (markReadBtn) {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-success read-badge';
                            badge.textContent = 'Read';
                            markReadBtn.parentNode.replaceChild(badge, markReadBtn);
                            item.classList.remove('unread-notification');
                        }
                    });
                    
                    // Update notification count in navbar
                    updateNotificationCount();
                }
            });
        }
    })
    .catch(error => {
        console.error('Error marking all notifications as read:', error);
        // Show error animation
        anime({
            targets: markAllBtn,
            translateX: [-5, 5, -5, 5, 0],
            duration: 400,
            easing: 'easeInOutQuad'
        });
    });
}

function updateNotificationCount() {
    // Update the notification dot in navbar
    const notificationDot = document.getElementById('notification-dot');
    if (notificationDot) {
        // Check if there are any remaining unread notifications
        const remainingUnread = document.querySelectorAll('.unread-notification').length;
        if (remainingUnread === 0) {
            anime({
                targets: notificationDot,
                opacity: [1, 0],
                scale: [1, 0],
                duration: 300,
                easing: 'easeOutCubic',
                complete: function() {
                    notificationDot.style.display = 'none';
                }
            });
        }
    }
}

// Add hover animations for notification items
document.addEventListener('DOMContentLoaded', function() {
    const notificationItems = document.querySelectorAll('.notification-item');
    
    notificationItems.forEach(item => {
        item.addEventListener('mouseenter', function() {
            anime({
                targets: this,
                translateX: [0, 5],
                duration: 200,
                easing: 'easeOutCubic'
            });
        });
        
        item.addEventListener('mouseleave', function() {
            anime({
                targets: this,
                translateX: [5, 0],
                duration: 200,
                easing: 'easeOutCubic'
            });
        });
    });
});
</script>

<style>
/* Notifications Page Styling */
.notifications-title {
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.notifications-card {
    border: none;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.notification-item {
    transition: all 0.3s ease;
    border-radius: 12px;
    margin-bottom: 0.5rem;
    padding: 1rem;
}

.notification-item:hover {
    background-color: #f8f9fa !important;
    transform: translateX(5px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.unread-notification {
    background-color: #f8f9fa;
    border-left: 4px solid var(--primary-color);
}

.notification-icon i {
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: rgba(99, 102, 241, 0.1);
}

.notification-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.notification-message {
    color: var(--text-secondary);
    line-height: 1.5;
}

.notification-time {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.notification-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.action-btn {
    border-radius: 8px;
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
    transition: all 0.3s ease;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.mark-read-btn {
    border-radius: 8px;
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
    transition: all 0.3s ease;
}

.mark-read-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.read-badge {
    font-size: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
}

.mark-all-btn {
    border-radius: 12px;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s ease;
}

.mark-all-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
}

/* Empty State Styling */
.empty-notifications-card {
    border: none;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

.empty-icon i {
    font-size: 4rem;
    color: var(--text-secondary);
    opacity: 0.5;
}

.empty-title {
    font-weight: 600;
    color: var(--text-secondary);
}

.empty-description {
    color: var(--text-secondary);
    max-width: 500px;
    margin: 0 auto;
    line-height: 1.6;
}

.browse-btn {
    border-radius: 12px;
    font-weight: 600;
    padding: 0.875rem 2rem;
    transition: all 0.3s ease;
    background: var(--gradient-primary);
    border: none;
}

.browse-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
}

/* Responsive Design */
@media (max-width: 768px) {
    .notification-item {
        padding: 0.75rem;
    }
    
    .notification-icon i {
        font-size: 1.25rem;
        width: 35px;
        height: 35px;
    }
    
    .notification-title {
        font-size: 1rem;
    }
    
    .notification-message {
        font-size: 0.875rem;
    }
    
    .action-btn, .mark-read-btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    .mark-all-btn {
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
    }
}

/* Animation Classes */
.fade-in {
    animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.slide-in {
    animation: slideIn 0.6s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}
</style>
{% endblock %} 